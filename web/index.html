<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fiquebot – Translate & Enrich</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ====== BACKEND ROUTING ====== -->
  <script>
    window.BACKEND_BASE =
      (location.hostname.endsWith('.azurestaticapps.net'))
        ? 'https://fique-csv-cng0ewddbhhwebe8.westeurope-01.azurewebsites.net'
        : ''; // same-origin for local FastAPI /ui
    function pickBackend() { return window.BACKEND_BASE; }
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Fiquebot – Self-Service Translation & Entity Extraction</h1>
      <div class="flex items-center gap-2 text-xs text-gray-600">
        <span>Backend:</span>
        <code id="backendBase" class="px-2 py-1 rounded bg-gray-200"></code>
        <button id="copyBackend" class="px-2 py-1 rounded bg-gray-900 text-white">Copy</button>
        <button id="pingBtn" class="px-2 py-1 rounded bg-emerald-600 text-white">/health OK</button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="flex gap-2">
      <button data-tab="upload" class="tab-btn px-4 py-2 rounded-xl bg-gray-900 text-white">Upload & Process (Async)</button>
      <button data-tab="existing" class="tab-btn px-4 py-2 rounded-xl bg-gray-200">Process Existing Blob (Sync)</button>
      <button data-tab="translate" class="tab-btn px-4 py-2 rounded-xl bg-gray-200">Translate Tester</button>
    </nav>

    <!-- Upload & Process (ASYNC) -->
    <section id="tab-upload" class="tab-panel bg-white rounded-2xl shadow p-5 space-y-4">
      <h3 class="font-semibold">Upload file & process (background job)</h3>
      <p class="text-sm text-gray-600">Starts a background job and auto-downloads when it’s ready.</p>
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">File (.xlsx / .xls / .xlsm / .csv)</span>
          <input id="fileInput" type="file" accept=".xlsx,.xls,.xlsm,.csv" class="mt-1 w-full rounded-xl border px-3 py-2 bg-white" />
        </label>
        <label class="block">
          <span class="text-sm">Text column (optional)</span>
          <input id="textColumnUpload" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g., message" />
        </label>
      </div>
      <div class="flex gap-3 items-center">
        <button id="btnUploadProcess" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Start job</button>
        <span id="uploadStatus" class="text-sm text-gray-700"></span>
      </div>

      <!-- Job progress -->
      <div id="jobPanel" class="hidden rounded-xl border p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">Job</div>
            <div id="jobId" class="text-xs text-gray-600"></div>
            <div id="runId" class="text-[11px] text-gray-500"></div>
          </div>
          <div class="text-right">
            <div id="jobState" class="text-sm font-semibold">queued</div>
            <div id="jobEta" class="text-xs text-gray-500"></div>
          </div>
        </div>

        <!-- Progress bar -->
        <div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progressBar" class="h-3 rounded-full bg-emerald-600 transition-all" style="width:0%"></div>
          </div>
          <div class="mt-1 text-xs text-gray-600">
            <span id="progressLabel">0%</span>
            <span id="progressCounts" class="ml-2">(0 / ? rows)</span>
          </div>
        </div>

        <div id="jobDownloadWrap" class="hidden">
          <a id="jobDownloadA" class="text-emerald-700 underline">Download enriched CSV</a>
        </div>
      </div>
    </section>

    <!-- Process Existing Blob (SYNC) -->
    <section id="tab-existing" class="tab-panel hidden bg-white rounded-2xl shadow p-5 space-y-4">
      <h3 class="font-semibold">Process an existing blob in <code>incoming/</code></h3>
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">Blob name (must start with <code>incoming/</code>)</span>
          <input id="blobName" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="incoming/sample.xlsx" />
        </label>
        <label class="block">
          <span class="text-sm">Text column (optional)</span>
          <input id="textColumnExisting" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g., message" />
        </label>
      </div>
      <div class="flex gap-3">
        <button id="btnProcessExisting" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Process (sync)</button>
        <span id="existingStatus" class="text-sm text-gray-700"></span>
      </div>
      <div id="existingDownloadLink" class="hidden">
        <a id="downloadLinkExisting" class="text-indigo-700 underline">Download enriched CSV</a>
      </div>
    </section>

    <!-- Translate Tester -->
    <section id="tab-translate" class="tab-panel hidden bg-white rounded-2xl shadow p-5 space-y-4">
      <h3 class="font-semibold">Translate Tester</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">Texts (one per line)</span>
          <textarea id="textsInput" rows="6" class="mt-1 w-full rounded-xl border px-3 py-2"></textarea>
        </label>
        <label class="block">
          <span class="text-sm">Target language</span>
          <input id="targetLang" value="en" class="mt-1 w-full rounded-xl border px-3 py-2" />
        </label>
      </div>
      <div class="flex gap-3">
        <button id="btnTranslate" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Translate</button>
        <span id="translateStatus" class="text-sm text-gray-700"></span>
      </div>
      <pre id="translateOutput" class="bg-gray-100 rounded-xl p-3 text-sm overflow-auto"></pre>
    </section>

    <!-- Logs -->
    <section class="bg-white rounded-2xl shadow p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Logs</h2>
        <div class="flex items-center gap-3">
          <label class="text-sm flex items-center gap-2">
            <input id="autoScroll" type="checkbox" class="rounded" checked />
            <span>Auto-scroll</span>
          </label>
          <label class="text-sm flex items-center gap-2">
            <input id="filterCurrentRun" type="checkbox" class="rounded" checked />
            <span>Only current job</span>
          </label>
          <button id="clearLogs" class="px-3 py-1 rounded bg-gray-200">Clear</button>
        </div>
      </div>
      <p class="text-xs text-gray-500">
        Shows browser logs and server logs from <code>GET /logs</code> (JSON; polled every ~5s).
        When “Only current job” is on, we filter by <code>run_id</code>.
      </p>
      <pre id="logs" class="bg-gray-100 rounded-xl p-3 text-xs h-56 overflow-auto"></pre>
    </section>
  </div>

  <script>
    // ---------- Tiny helpers ----------
    const $ = (id) => document.getElementById(id);
    function setBusy(el, busy) { if (!el) return; el.disabled = !!busy; el.classList.toggle('opacity-50', !!busy); }
    function lineify(v) { return (typeof v === 'string' ? v : JSON.stringify(v)); }
    function logln(...args) {
      const el = $('logs');
      const line = args.map(lineify).join(' ');
      el.textContent += line + '\n';
      if ($('autoScroll').checked) el.scrollTop = el.scrollHeight;
      console.log(...args);
    }
    function filenameFromContentDisposition(h) {
      if (!h) return null; const m = /filename="?([^"]+)"?/i.exec(h); return m ? m[1] : null;
    }
    function setActiveTab(name) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('bg-gray-900', 'text-white'));
      $(`tab-${name}`).classList.remove('hidden');
      document.querySelector(`.tab-btn[data-tab="${name}"]`).classList.add('bg-gray-900', 'text-white');
    }
    document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => setActiveTab(b.dataset.tab)));
    setActiveTab('upload');

    // ---------- Header wiring ----------
    $('backendBase').textContent = pickBackend() || '(same-origin)';
    $('copyBackend').addEventListener('click', async () => {
      await navigator.clipboard.writeText(pickBackend());
      logln('Copied backend:', pickBackend());
    });
    $('pingBtn').addEventListener('click', async () => {
      try {
        const url = pickBackend() + '/health';
        logln('GET', url);
        const r = await fetch(url);
        logln('Response', r.status, r.ok ? 'ok' : '');
        alert(r.ok ? 'health OK' : `health failed ${r.status}`);
      } catch (e) { logln('Ping failed:', e.toString()); alert('Ping failed: ' + e.toString()); }
    });

    // ---------- Server log polling (/logs JSON) ----------
    let currentRunId = null;
    async function pollServerLogs() {
      const base = pickBackend();
      if (!base) return;
      try {
        const r = await fetch(base + '/logs'); // returns {items, count}
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        const items = Array.isArray(j.items) ? j.items : [];
        // Render nicely (filtered if requested)
        const onlyCurrent = $('filterCurrentRun').checked && currentRunId;
        const lines = [];
        for (const it of items) {
          const msg = it.message || it; // ring buffer stores obj in message
          const ev = (msg && msg.event) ? msg.event : null;
          const rid = (msg && msg.run_id) ? msg.run_id : null;
          if (onlyCurrent && rid && rid !== currentRunId) continue;
          const ts = it.ts || '';
          lines.push(`${ts} ${ev ? '['+ev+'] ' : ''}${JSON.stringify(msg)}`);
        }
        // clear + re-render succinctly
        const el = $('logs');
        el.textContent = (lines.length ? lines.join('\n') + '\n' : el.textContent);
        if ($('autoScroll').checked) el.scrollTop = el.scrollHeight;
      } catch (e) {
        logln('Server log poll error:', e.toString());
      }
    }
    setInterval(pollServerLogs, 5200);
    setTimeout(pollServerLogs, 800);
    $('clearLogs').addEventListener('click', () => { $('logs').textContent = ''; });

    // ---------- Upload & process (ASYNC) ----------
    $('btnUploadProcess').addEventListener('click', async () => {
      const btn = $('btnUploadProcess');
      const file = $('fileInput').files[0];
      const textCol = $('textColumnUpload').value.trim();
      const status = $('uploadStatus');
      const jobPanel = $('jobPanel');
      const jobIdEl = $('jobId');
      const jobStateEl = $('jobState');
      const jobEtaEl = $('jobEta');
      const runIdEl = $('runId');
      const jobDownloadWrap = $('jobDownloadWrap');
      const jobDownloadA = $('jobDownloadA');
      const progressBar = $('progressBar');
      const progressLabel = $('progressLabel');
      const progressCounts = $('progressCounts');

      jobPanel.classList.add('hidden');
      jobDownloadWrap.classList.add('hidden');
      status.textContent = '';
      progressBar.style.width = '0%';
      progressLabel.textContent = '0%';
      progressCounts.textContent = '(0 / ? rows)';
      currentRunId = null;

      if (!file) { status.textContent = 'Pick a .xlsx/.xls/.xlsm/.csv file.'; return; }

      setBusy(btn, true);
      try {
        const fd = new FormData();
        fd.append('file', file);
        if (textCol) fd.append('text_column', textCol);

        const startUrl = pickBackend() + '/process-upload-async';
        logln('POST', startUrl, '(multipart/form-data)', file.name);
        const startResp = await fetch(startUrl, { method: 'POST', body: fd });
        const startText = await startResp.clone().text().catch(() => null);
        if (!startResp.ok) throw new Error(startText || startResp.statusText);
        const { job_id } = await startResp.json();
        if (!job_id) throw new Error('No job_id returned');
        status.textContent = 'Job started…';
        jobIdEl.textContent = job_id;
        jobStateEl.textContent = 'queued';
        jobEtaEl.textContent = '';
        jobPanel.classList.remove('hidden');

        const jobUrl = pickBackend() + '/jobs/' + encodeURIComponent(job_id);
        const progUrl = pickBackend() + '/jobs/' + encodeURIComponent(job_id) + '/progress';
        const dlUrl = pickBackend() + '/jobs/' + encodeURIComponent(job_id) + '/download';

        // First fetch full job to discover run_id
        try {
          const r0 = await fetch(jobUrl);
          const j0 = await r0.json();
          if (j0 && j0.run_id) {
            currentRunId = j0.run_id;
            runIdEl.textContent = 'run_id: ' + currentRunId;
          }
        } catch {}

        async function poll() {
          try {
            const r = await fetch(progUrl);
            if (!r.ok) throw new Error('HTTP ' + r.status);
            const j = await r.json();
            const { state, rows_processed, total_rows, run_id } = j;

            if (run_id && !currentRunId) {
              currentRunId = run_id;
              runIdEl.textContent = 'run_id: ' + currentRunId;
            }

            jobStateEl.textContent = state || 'unknown';
            if (state === 'running') jobEtaEl.textContent = 'working…';
            else if (state === 'queued') jobEtaEl.textContent = 'waiting to start…';
            else jobEtaEl.textContent = '';

            const haveTotal = (typeof total_rows === 'number' && total_rows > 0);
            const pct = haveTotal ? Math.min(100, Math.round(100 * (rows_processed || 0) / total_rows)) : null;
            progressBar.style.width = (pct === null ? '100%' : pct + '%');
            progressBar.classList.toggle('animate-pulse', pct === null && state === 'running');
            progressLabel.textContent = (pct === null ? '…' : `${pct}%`);
            progressCounts.textContent = `(${rows_processed || 0} / ${haveTotal ? total_rows : '?' } rows)`;

            if (state === 'done') {
              const resp = await fetch(dlUrl);
              if (!resp.ok) throw new Error('Download failed ' + resp.status);
              const disp = resp.headers.get('Content-Disposition');
              const fname = filenameFromContentDisposition(disp) || 'enriched.csv';
              const blob = await resp.blob();
              const href = URL.createObjectURL(blob);

              // auto-download
              const a = document.createElement('a');
              a.href = href; a.download = fname; document.body.appendChild(a); a.click(); a.remove();

              // persistent link
              jobDownloadA.href = href; jobDownloadA.download = fname;
              jobDownloadWrap.classList.remove('hidden');
              status.textContent = 'Done. File downloaded.';
              progressBar.style.width = '100%';
              progressLabel.textContent = '100%';
              return;
            }

            if (state === 'error') {
              const metaR = await fetch(jobUrl);
              const meta = await metaR.json().catch(() => ({}));
              status.textContent = 'Job error. See logs.';
              alert('Job failed: ' + (meta.error || 'unknown'));
              return;
            }
          } catch (e) {
            logln('Job poll error:', e.toString());
          }
          setTimeout(poll, 1200);
        }
        setTimeout(poll, 900);

      } catch (e) {
        status.textContent = 'Error (see logs).';
        logln('Upload/Process error:', e.toString());
        alert('Error: ' + e.toString());
      } finally {
        setBusy($('btnUploadProcess'), false);
      }
    });

    // ---------- Process existing blob (SYNC) ----------
    $('btnProcessExisting').addEventListener('click', async () => {
      const btn = $('btnProcessExisting');
      const blobName = $('blobName').value.trim();
      const textCol = $('textColumnExisting').value.trim();
      const status = $('existingStatus');
      const dlWrap = $('existingDownloadLink');
      const dlA = $('downloadLinkExisting');
      dlWrap.classList.add('hidden');
      status.textContent = '';
      if (!blobName || !blobName.startsWith('incoming/')) {
        status.textContent = "Provide a blob name like 'incoming/sample.xlsx'.";
        return;
      }
      setBusy(btn, true);
      try {
        const q = new URLSearchParams();
        q.set('blob_name', blobName);
        if (textCol) q.set('text_column', textCol);
        const url = pickBackend() + '/process-xlsx?' + q.toString();
        logln('POST', url);
        const resp = await fetch(url, { method: 'POST' });
        const bodyTxt = await resp.clone().text().catch(() => null);
        if (!resp.ok) {
          status.textContent = 'Processing failed';
          logln('Error body:', bodyTxt || '(no body)');
          alert('Processing failed: ' + (bodyTxt || resp.statusText));
          return;
        }
        const disp = resp.headers.get('Content-Disposition');
        const fname = filenameFromContentDisposition(disp) || (blobName.split('/').pop().replace(/\.[^.]+$/, '') + '_enriched.csv');
        const outBlob = await resp.blob();
        const href = URL.createObjectURL(outBlob);

        // auto-download
        const a = document.createElement('a');
        a.href = href; a.download = fname; document.body.appendChild(a); a.click(); a.remove();

        // persistent link
        dlA.href = href; dlA.download = fname; dlWrap.classList.remove('hidden');
        status.textContent = 'Done. File downloaded.';
        logln('Ready to download:', fname);
      } catch (e) {
        status.textContent = 'Error (see logs).';
        logln('Process existing error:', e.toString());
        alert('Error: ' + e.toString());
      } finally {
        setBusy(btn, false);
      }
    });

    // ---------- Translate tester ----------
    $('btnTranslate').addEventListener('click', async () => {
      const btn = $('btnTranslate');
      const out = $('translateOutput');
      const status = $('translateStatus');
      out.textContent = ''; status.textContent = '';
      const lines = $('textsInput').value.split('\n').map(s => s.trim()).filter(Boolean);
      const to = $('targetLang').value.trim() || 'en';
      if (lines.length === 0) { status.textContent = 'Enter one or more lines.'; return; }
      setBusy(btn, true);
      try {
        const url = pickBackend() + '/translate';
        const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ texts: lines, to }) });
        const j = await resp.json().catch(() => null);
        if (!resp.ok) throw new Error(JSON.stringify(j || { error: resp.statusText }));
        out.textContent = JSON.stringify(j, null, 2);
        status.textContent = 'OK';
        logln('POST', url, '200 OK');
      } catch (e) {
        status.textContent = 'Error (see logs).';
        logln('Translate error:', e.toString());
      } finally { setBusy(btn, false); }
    });

    // ----- Initial ping on load -----
    (async function pingBackend() {
      try {
        const url = pickBackend() + '/health';
        logln('GET', url);
        const r = await fetch(url);
        logln('Response', r.status, r.ok ? 'ok' : '');
        const j = await r.json().catch(() => null);
        logln('Body:', j || '(no json body)');
      } catch (e) { logln('Ping failed:', e.toString()); }
    })();
  </script>
</body>
</html>
